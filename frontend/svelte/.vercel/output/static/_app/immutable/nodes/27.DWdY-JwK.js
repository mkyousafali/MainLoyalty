import"../chunks/DsnmJJEf.js";import"../chunks/69_IOA4Y.js";import{o as Te}from"../chunks/Y1pQyyvi.js";import{l as Ie,m as S,t as E,v as a,a as t,x as M,n as w,o as qe,w as o,s as n,y as D,I as R,A as Ye,z as r,E as rt,B as v,H as je,C as Oe}from"../chunks/Ck91ypkQ.js";import{i as N}from"../chunks/RujGBxXx.js";import{e as ht,i as yt}from"../chunks/D775oJua.js";import{r as dt}from"../chunks/DvH4tfbe.js";import{s as nt}from"../chunks/B38bOHRo.js";import{s as ie}from"../chunks/CNyBBxAM.js";import{a as ct}from"../chunks/C4HntxLm.js";import{b as Le}from"../chunks/xkiwYR4x.js";import{b as Ve}from"../chunks/J-1wTRcM.js";import{i as We}from"../chunks/6tn_K0LM.js";import{s as q}from"../chunks/CIOq__Tp.js";import{u as h}from"../chunks/DHqA4AUT.js";import{u as pt,w as Je,r as de}from"../chunks/480hx4lC.js";var ze=S('<span class="text-red-600"> </span>'),Qe=S('<div class="flex gap-2 mb-3"><button class="px-3 py-1 bg-orange-500 text-white rounded text-sm hover:bg-orange-600 transition-colors">â¸ï¸ Pause</button> <button class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">ğŸš« Cancel</button></div>'),Ge=S('<div class="flex gap-2 mb-3"><button class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors">â–¶ï¸ Resume</button> <button class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">ğŸš« Cancel</button></div>'),He=S("<span> </span>"),Ke=S("<span> </span>"),Xe=S('<div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-md"><p class="text-sm text-red-700"> </p></div>'),Ze=S('<div><div class="flex items-center justify-between mb-4"><h2 class="text-lg font-semibold flex items-center gap-2"><span class="text-2xl"> </span> Last Upload Status</h2> <a href="/admin/upload-status" class="text-blue-600 hover:text-blue-700 text-sm font-medium">View All Uploads â†’</a></div> <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><div><p class="text-sm text-gray-600">File Name</p> <p class="font-medium"> </p></div> <div><p class="text-sm text-gray-600">Status</p> <p> </p></div> <div><p class="text-sm text-gray-600">Progress</p> <p class="font-medium"> <!></p></div></div> <div class="mb-3"><div class="flex justify-between text-sm text-gray-600 mb-1"><span>Progress</span> <span> </span></div> <div class="w-full bg-gray-200 rounded-full h-2"><div></div></div></div> <!> <!> <div class="flex flex-wrap gap-4 text-sm text-gray-600"><span> </span> <!> <!></div> <!></div>'),tr=S('<div class="flex gap-1"><button class="px-2 py-1 bg-orange-500 text-white rounded text-xs hover:bg-orange-600" title="Pause Upload">â¸ï¸</button> <button class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600" title="Cancel Upload">ğŸš«</button></div>'),er=S('<div class="flex gap-1"><button class="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600" title="Resume Upload">â–¶ï¸</button> <button class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600" title="Cancel Upload">ğŸš«</button></div>'),rr=S('<span class="text-gray-400 text-xs">-</span>'),ar=S('<tr class="hover:bg-gray-50"><td class="px-3 py-2"><div class="flex items-center gap-2"><span class="text-lg"> </span> <span class="font-medium"> </span></div></td><td class="px-3 py-2"><span> </span></td><td class="px-3 py-2"><div class="flex items-center gap-2"><div class="w-16 bg-gray-200 rounded-full h-1.5"><div></div></div> <span class="text-xs"> </span></div></td><td class="px-3 py-2 text-gray-600"> </td><td class="px-3 py-2"><!></td></tr>'),sr=S('<div class="bg-white rounded-lg shadow p-6 mb-6"><div class="flex items-center justify-between mb-4"><h2 class="text-lg font-semibold">Recent Uploads</h2> <a href="/admin/upload-status" class="text-blue-600 hover:text-blue-700 text-sm font-medium">View Dashboard â†’</a></div> <div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left font-medium text-gray-700">File</th><th class="px-3 py-2 text-left font-medium text-gray-700">Status</th><th class="px-3 py-2 text-left font-medium text-gray-700">Progress</th><th class="px-3 py-2 text-left font-medium text-gray-700">Time</th><th class="px-3 py-2 text-left font-medium text-gray-700">Actions</th></tr></thead><tbody class="divide-y divide-gray-200"></tbody></table></div></div>'),or=S("<option> </option>"),lr=S('<tr class="border-t"><td class="px-3 py-2 text-xs"> </td><td class="px-3 py-2 text-xs"> </td><td class="px-3 py-2 text-xs"> </td><td class="px-3 py-2 text-xs"> </td><td class="px-3 py-2 text-xs font-mono"> </td><td class="px-3 py-2 text-xs"> </td><td class="px-3 py-2 text-xs"> </td><td class="px-3 py-2 text-xs"><span> </span></td></tr>'),ir=S('<div class="mb-4"><h3 class="font-medium mb-2">File Preview (First 5 rows)</h3> <div class="overflow-x-auto"><table class="min-w-full border border-gray-200 rounded-lg text-sm"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-700">Row</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700">Bill No</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700">Date</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700">Amount</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700">Customer</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700">Add</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700">Redeem</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700">Status</th></tr></thead><tbody></tbody></table></div></div>'),dr=S('<div class="bg-white rounded-lg shadow p-6 mb-6"><h2 class="text-lg font-semibold mb-4">Upload Statistics</h2> <div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div class="text-center p-4 bg-blue-50 rounded-lg"><div class="text-2xl font-bold text-blue-600"> </div> <div class="text-sm text-gray-600">Total Records</div></div> <div class="text-center p-4 bg-green-50 rounded-lg"><div class="text-2xl font-bold text-green-600"> </div> <div class="text-sm text-gray-600">Successful</div></div> <div class="text-center p-4 bg-yellow-50 rounded-lg"><div class="text-2xl font-bold text-yellow-600"> </div> <div class="text-sm text-gray-600">Invalid Customers</div></div> <div class="text-center p-4 bg-red-50 rounded-lg"><div class="text-2xl font-bold text-red-600"> </div> <div class="text-sm text-gray-600">Other Errors</div></div></div></div>'),nr=S('<tr class="border-t"><td class="px-4 py-2 text-sm"> </td><td class="px-4 py-2 text-sm font-mono"> </td><td class="px-4 py-2 text-sm text-red-600"> </td></tr>'),cr=S('<div class="bg-white rounded-lg shadow p-6 mb-6"><h2 class="text-lg font-semibold mb-4 text-red-600">Upload Errors</h2> <div class="overflow-x-auto"><table class="min-w-full border border-gray-200 rounded-lg"><thead class="bg-red-50"><tr><th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Row</th><th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Customer</th><th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Error</th></tr></thead><tbody></tbody></table></div></div>'),ur=S('<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"> </div>'),mr=S('<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"> </div>'),vr=S('<div class="max-w-6xl mx-auto"><div class="mb-8"><h1 class="text-3xl font-bold text-gray-900 mb-2">Upload Transactions</h1> <p class="text-gray-600">Add customer transactions manually or upload from Excel file with automatic points calculation.</p></div> <!> <!> <div class="bg-white rounded-lg shadow p-6 mb-6"><h2 class="text-lg font-semibold mb-4">Select Branch</h2> <select class="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required><option>Choose a branch...</option><!></select></div> <div class="bg-white rounded-lg shadow p-6 mb-6"><h2 class="text-lg font-semibold mb-4">Manual Transaction Entry</h2> <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Bill Number</label> <input type="text" placeholder="INV001" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/></div> <div><label class="block text-sm font-medium text-gray-700 mb-2">Bill Date</label> <input type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/></div> <div><label class="block text-sm font-medium text-gray-700 mb-2">Bill Amount (ï·¼)</label> <input type="number" step="0.01" placeholder="100.50" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/></div> <div><label class="block text-sm font-medium text-gray-700 mb-2">Customer Mobile</label> <input type="text" placeholder="5xxxxxxxx" maxlength="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/></div> <div><label class="block text-sm font-medium text-gray-700 mb-2">Points to Add</label> <input type="number" placeholder="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/></div> <div><label class="block text-sm font-medium text-gray-700 mb-2">Points to Redeem</label> <input type="number" placeholder="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/></div></div> <button class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"> </button></div> <div class="bg-white rounded-lg shadow p-6 mb-6"><div class="flex justify-between items-center mb-4"><h2 class="text-lg font-semibold">Excel File Upload</h2> <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm flex items-center gap-2"><span>ğŸ“¥</span> Download Template</button></div> <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Choose Excel File</label> <input type="file" accept=".xlsx,.xls" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/> <p class="text-sm text-gray-500 mt-1">Columns: Bill No, Bill Date (YYYY-MM-DD), Bill Amount, Customer Mobile, Points to Add, Points to Redeem</p></div> <!> <div class="flex gap-4"><button class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"> </button> <button class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">Clear All</button></div></div> <!> <!> <!> <!></div>');function Fr(ne,ce){Ie(ce,!1);let wt=D([]),P=D(""),z=D(!1),U=D(""),G=D(""),ut="",bt="",m=D(null),xt=D([]),St=D(!1),g=D({bill_no:"",bill_date:"",bill_amount:"",customer:"",add_amt:"",redeem:""}),mt=D(),at=D(null),$=D([]),$t=D(!1),st=D({total:0,successful:0,errors:0,invalidCustomers:0}),Ut=D([]);Te(()=>{ue(),Ot(),Lt(),console.log("Upload Manager:",h),console.log("Active uploads store:",h.activeUploadsStore),console.log("Completed uploads store:",h.completedUploadsStore)});async function Ot(){try{h.activeUploadsStore.subscribe(e=>{const s=Array.from(e.values());if(s.length>0){const i=s[0];n(m,{id:i.jobId,fileName:i.fileName,status:i.status,progress:i.progress,created_at:new Date().toISOString(),error_msg:i.error}),n(St,!0),console.log("Active upload found:",t(m))}}),h.completedUploadsStore.subscribe(e=>{e.length>0&&!t(m)&&(n(m,e[0]),n(St,!0),console.log("Completed upload found:",t(m)))})}catch(e){console.error("Failed to load last upload status:",e)}}async function Lt(){try{h.activeUploadsStore.subscribe(e=>{h.completedUploadsStore.subscribe(s=>{const i=Array.from(e.values()).map(d=>({id:d.jobId,fileName:d.fileName,status:d.status,progress:d.progress,created_at:new Date().toISOString(),error_msg:d.error}));n(xt,[...i,...s.slice(0,5)].sort((d,p)=>new Date(p.created_at).getTime()-new Date(d.created_at).getTime())),console.log("Recent uploads updated:",t(xt))})})}catch(e){console.error("Failed to load recent uploads:",e)}}async function ue(){try{const{data:e,error:s}=await q.from("branches").select("*").order("name_en");if(s)throw s;n(wt,e||[])}catch(e){n(U,`Failed to load branches: ${e.message}`)}}function Vt(e){const s=e.replace(/\s/g,"");return/^5\d{8}$/.test(s)||/^05\d{8}$/.test(s)}async function Wt(e,s){console.log(`ğŸ” Validating customer: ${e} for branch: ${s}`),console.log(`ğŸ“ Mobile type: ${typeof e}, Branch type: ${typeof s}`),console.log(`ğŸ“ Mobile length: ${e.length}, Branch length: ${s.length}`);let i=e,d=null;e.startsWith("05")&&e.length===10?d=e.substring(1):e.length===9&&e.startsWith("5")&&(d="0"+e),console.log(`ğŸ”„ Attempting customer lookup by mobile: ${i}`);let{data:p,error:b}=await q.from("customers").select("id, name, points, branch_id, customer_code, mobile").eq("mobile",i).single();if(console.log("ğŸ”„ Customer lookup result:",{customer:p,error:b}),console.log("ğŸ“Š Error details:",b),(!p||b)&&d){console.log(`ğŸ”„ Trying alternative mobile format: ${d}`);const c=await q.from("customers").select("id, name, points, branch_id, customer_code, mobile").eq("mobile",d).single();!c.error&&c.data&&(p=c.data,b=c.error)}if(!b&&p)return console.log("âœ… Found existing customer:",p),p;if(b&&b.code==="PGRST116"){console.log(`ğŸ”„ Trying customer lookup by customer_code: ${i}`);let{data:c,error:y}=await q.from("customers").select("id, name, points, branch_id, customer_code, mobile").eq("customer_code",i).single();if((!c||y)&&d){console.log(`ğŸ”„ Trying alternative customer_code format: ${d}`);const k=await q.from("customers").select("id, name, points, branch_id, customer_code, mobile").eq("customer_code",d).single();!k.error&&k.data&&(c=k.data,y=k.error)}if(console.log("ğŸ”„ Customer code lookup result:",{customerByCode:c,codeError:y}),!y&&c)return console.log("âœ… Found existing customer by code:",c),c}console.log("ğŸ” Checking eligibility in customer_numbers table..."),console.log(`ğŸ”„ Attempting eligibility check with query: customer.eq.${i}`);let{data:l,error:u}=await q.from("customer_numbers").select("customer, status, branch_id").eq("customer",i).single();if((!l||u)&&d){console.log(`ğŸ”„ Trying alternative customer_numbers format: ${d}`);const c=await q.from("customer_numbers").select("customer, status, branch_id").eq("customer",d).single();!c.error&&c.data&&(l=c.data,u=c.error)}if(console.log("ğŸ”„ Eligibility check result:",{eligibleCustomer:l,eligibilityError:u}),console.log("ğŸ“Š Eligibility error details:",u),!u&&l){if(l.status==="registered")throw console.log("âš ï¸ Customer marked as registered but not found in customers table"),new Error("Customer marked as registered but not found in customers table");return console.log("âœ… Found eligible unregistered customer"),{id:null,name:`Unregistered Customer ${e}`,points:0,branch_id:l.branch_id,customer_code:e,mobile:e,isUnregistered:!0}}console.log(`ğŸ“ Auto-adding new customer ${e} to eligible list for branch ${s}`),console.log("ğŸ“ Insert data:",{customer:e,status:"not_registered",branch_id:s,uploaded_at:new Date().toISOString()});const{error:x}=await q.from("customer_numbers").insert({customer:e,status:"not_registered",branch_id:s,uploaded_at:new Date().toISOString()});if(console.log("ğŸ”„ Auto-add result:",{insertError:x}),console.log("ğŸ“Š Insert error details:",x),x)throw console.error("âŒ Failed to auto-add customer:",x),new Error(`Failed to add customer ${e} to eligible list: ${x.message}`);return console.log("âœ… Successfully auto-added customer to eligible list"),{id:null,name:`New Customer ${e}`,points:0,branch_id:s,customer_code:e,mobile:e,isUnregistered:!0,isNewlyAdded:!0}}async function me(){if(!t(P)){n(U,"Please select a branch first");return}if(!Vt(t(g).customer)){n(U,"Please enter a valid 10-digit Saudi mobile number starting with 5");return}if(!t(g).bill_no.trim()){n(U,"Please enter bill number");return}if(!t(g).bill_date){n(U,"Please enter bill date");return}if(!t(g).bill_amount||parseFloat(t(g).bill_amount)<=0){n(U,"Please enter a valid bill amount");return}try{n(z,!0),n(U,"");const e=await Wt(t(g).customer,t(P)),s=parseFloat(t(g).add_amt)||0,i=parseFloat(t(g).redeem)||0,p=(e.points||0)+s-i,{error:b}=await q.from("customer_transactions").insert({bill_no:t(g).bill_no.trim(),bill_date:t(g).bill_date,bill_amount:parseFloat(t(g).bill_amount),customer_id:e.isUnregistered?null:e.id,customer_code:t(g).customer,customer_mobile:t(g).customer,branch_id:t(P),transaction_type:"purchase",amount:parseFloat(t(g).bill_amount),points_earned:s,points_used:i,add_amt:s,redeem:i,balance_after:p,status:"completed",transaction_date:new Date().toISOString(),processed_at:new Date().toISOString()});if(b)throw b;const{error:l}=await q.from("customers").update({points:p,total_spent:e.total_spent+parseFloat(t(g).bill_amount)}).eq("id",e.id);if(l)throw l;await fe("manual_entry",1,1,0,[]),n(G,"Transaction added successfully!"),n(g,{bill_no:"",bill_date:"",bill_amount:"",customer:"",add_amt:"",redeem:""})}catch(e){n(U,`Failed to add transaction: ${e.message}`)}finally{n(z,!1)}}function ve(e){const s=e.target.files?.[0];s&&(n(at,s),ge(s))}async function ge(e){try{const s=await e.arrayBuffer(),i=de(s,{type:"array"}),d=i.SheetNames[0],p=i.Sheets[d],b=pt.sheet_to_json(p,{header:1});n($,b.slice(1,6).map((l,u)=>{let x=l[3]?.toString().trim()||"",c=x;return x.length===9&&x.startsWith("5")?c="0"+x:x.startsWith("05")&&x.length===10&&(c=x),{rowNumber:u+2,bill_no:l[0]?.toString().trim()||"",bill_date:l[1]?.toString().trim()||"",bill_amount:l[2]?.toString().trim()||"",customer:c,add_amt:l[4]?.toString().trim()||"",redeem:l[5]?.toString().trim()||"",status:"Checking..."}})),await pe(),n($t,!0),n(U,"")}catch(s){n(U,`Failed to preview file: ${s.message}`)}}async function pe(){if(!(!t(P)||!t($).length)){console.log(`ğŸ” Starting preview validation with selectedBranch: "${t(P)}"`),console.log(`ğŸ“‹ Preview data length: ${t($).length}`);for(let e=0;e<t($).length;e++){const s=t($)[e];console.log(`ğŸ”„ Processing preview row ${e+1}:`,s);try{if(!Vt(s.customer)){console.log(`âŒ Mobile validation failed for: ${s.customer}`),R($,t($)[e].status="âœ— Invalid Mobile");continue}console.log(`âœ… Mobile validation passed for: ${s.customer}`),console.log(`ğŸ” About to validate customer: ${s.customer} for branch: "${t(P)}"`);const i=await Wt(s.customer,t(P));console.log("âœ… Customer validation successful:",i),i.isNewlyAdded?R($,t($)[e].status="âœ¨ Auto-Added New Customer"):i.isUnregistered?R($,t($)[e].status="â³ Eligible (Not Registered)"):R($,t($)[e].status="âœ… Registered Customer")}catch(i){console.error(`âŒ Customer validation failed for ${s.customer}:`,i),R($,t($)[e].status="âœ— Not Eligible")}}n($,[...t($)])}}async function be(){if(!t(at)||!t(P)){n(U,"Please select both a file and a branch");return}await xe()}async function xe(){try{n(z,!0),n(U,""),n(G,""),ut="Reading Excel file...";const e=await t(at).arrayBuffer(),s=de(e,{type:"array"}),i=s.SheetNames[0],d=s.Sheets[i],b=pt.sheet_to_json(d,{header:1}).slice(1).filter(u=>u.length>0);ut=`Queuing ${b.length} transactions for background processing...`;const l=b.map((u,x)=>{let c=u[3]?.toString().trim()||"";return c.length===9&&c.startsWith("5")&&(c="0"+c),{customer_mobile:c,amount:parseFloat(u[2]?.toString().trim()||"0"),transaction_id:u[0]?.toString().trim()||"",date:u[1]?.toString().trim()||"",notes:`Points Add: ${u[4]||0}, Points Redeem: ${u[5]||0}`,_row:{bill_no:u[0]?.toString().trim()||"",bill_date:u[1]?.toString().trim()||"",bill_amount:parseFloat(u[2]?.toString().trim()||"0"),add_amt:parseFloat(u[4]?.toString().trim()||"0"),redeem:parseFloat(u[5]?.toString().trim()||"0"),rowNumber:x+2}}});ut="Submitting to upload queue...",bt=await h.startUpload(t(at),t(P)),n(G,`Upload queued successfully! Job ID: ${bt}. Processing will continue in background.`),ut="Upload queued for background processing",_e(),Ot(),Lt()}catch(e){n(U,`Failed to queue upload: ${e.message}`)}finally{n(z,!1)}}async function _e(){if(!bt)return;const e=setInterval(async()=>{const s=await h.getUploadStatus(bt);s&&(s.progress,h.getProgressPercentage(s),s.status==="processing"?ut=`Processing: ${s.progress.processed}/${s.progress.total} transactions`:s.status==="completed"?(n(G,`Upload completed! ${s.progress.processed} transactions processed, ${s.progress.failed} failed.`),clearInterval(e)):s.status==="failed"&&(n(U,`Upload failed: ${s.error_msg||"Unknown error"}`),clearInterval(e)))},2e3);setTimeout(()=>clearInterval(e),1800*1e3)}async function fe(e,s,i,d,p){try{const b=JSON.parse(localStorage.getItem("adminUser")||"{}"),{error:l}=await q.from("transaction_upload_logs").insert({uploaded_by:b.id||null,branch_id:t(P),file_name:e,record_count:s,success_count:i,error_count:d,errors:p,uploaded_at:new Date().toISOString()});l&&console.warn("Failed to log upload (table may not exist):",l)}catch(b){console.warn("Failed to log upload:",b)}}function he(){const e=[["Bill No","Bill Date (YYYY-MM-DD)","Bill Amount","Customer Mobile","Points to Add","Points to Redeem"],["545439","2025-07-27","27.9","0500014006","0.28","0"],["555741","2025-08-04","284.86","0500014006","2.85","0"],["479569","2025-05-30","21.24","0500019376","0.11","0"],["493515","2025-06-11","153.02","0500019376","1.53","0"],["497543","2025-06-15","94.39","0500019376","0.94","0"],["","","","","",""],["INSTRUCTIONS:","","","","",""],["â€¢ Bill No: Unique invoice/receipt number","","","","",""],["â€¢ Bill Date: Format YYYY-MM-DD (e.g. 2025-08-07)","","","","",""],["â€¢ Bill Amount: Total purchase amount in ï·¼","","","","",""],["â€¢ Customer Mobile: Saudi mobile number (5xxxxxxxx or 05xxxxxxxx)","","","","",""],["â€¢ Points to Add: Points earned from this transaction","","","","",""],["â€¢ Points to Redeem: Points used in this transaction","","","","",""],["","","","","",""],["NOTES:","","","","",""],["â€¢ Mobile numbers starting with 05 will be auto-normalized to 5","","","","",""],["â€¢ Unknown customers will be automatically added to the system","","","","",""],["â€¢ All fields are required except Points to Redeem (can be 0)","","","","",""]],s=pt.book_new(),i=pt.aoa_to_sheet(e);i["!cols"]=[{width:15},{width:15},{width:12},{width:15},{width:12},{width:12}],pt.book_append_sheet(s,i,"Transaction Template"),Je(s,"urban_market_transactions_template.xlsx")}function ye(){n(at,null),n($,[]),n($t,!1),n(st,{total:0,successful:0,errors:0,invalidCustomers:0}),n(Ut,[]),n(U,""),n(G,""),t(mt)&&R(mt,t(mt).value="")}We();var kt=vr(),Jt=o(a(kt),2);{var we=e=>{var s=Ze(),i=a(s),d=a(i),p=a(d),b=a(p,!0);r(p),rt(),r(d),rt(2),r(i);var l=o(i,2),u=a(l),x=o(a(u),2),c=a(x,!0);r(x),r(u);var y=o(u,2),k=o(a(y),2),A=a(k,!0);r(k),r(y);var T=o(y,2),F=o(a(T),2),Y=a(F),H=o(Y);{var K=_=>{var f=ze(),C=a(f);r(f),E(()=>v(C,`(${t(m).progress.failed??""} failed)`)),w(_,f)};N(H,_=>{t(m).progress.failed>0&&_(K)})}r(F),r(T),r(l);var j=o(l,2),V=a(j),W=o(a(V),2),ot=a(W);r(W),r(V);var X=o(V,2),O=a(X);r(X),r(j);var Z=o(j,2);{var lt=_=>{var f=Qe(),C=a(f),I=o(C,2);r(f),M("click",C,()=>h.pauseUpload(t(m).id)),M("click",I,()=>h.cancelUpload(t(m).id)),w(_,f)};N(Z,_=>{t(m).status==="processing"&&_(lt)})}var it=o(Z,2);{var Yt=_=>{var f=Ge(),C=a(f),I=o(C,2);r(f),M("click",C,()=>h.resumeUpload(t(m).id)),M("click",I,()=>h.cancelUpload(t(m).id)),w(_,f)};N(it,_=>{t(m).status==="paused"&&_(Yt)})}var gt=o(it,2),B=a(gt),L=a(B);r(B);var J=o(B,2);{var tt=_=>{var f=He(),C=a(f);r(f),E(I=>v(C,`Processing: ${I??""}`),[()=>new Date(t(m).started_at).toLocaleString()]),w(_,f)};N(J,_=>{t(m).started_at&&_(tt)})}var jt=o(J,2);{var Q=_=>{var f=Ke(),C=a(f);r(f),E(I=>v(C,`Completed: ${I??""}`),[()=>new Date(t(m).completed_at).toLocaleString()]),w(_,f)};N(jt,_=>{t(m).completed_at&&_(Q)})}r(gt);var et=o(gt,2);{var ft=_=>{var f=Xe(),C=a(f),I=a(C,!0);r(C),r(f),E(()=>v(I,t(m).error_msg)),w(_,f)};N(et,_=>{t(m).error_msg&&_(ft)})}r(s),E((_,f,C,I,Be,Re)=>{nt(s,1,`bg-white rounded-lg shadow p-6 mb-6 border-l-4 ${t(m).status==="completed"?"border-green-500":t(m).status==="failed"?"border-red-500":t(m).status==="processing"?"border-blue-500":"border-yellow-500"}`),v(b,_),v(c,t(m).fileName),nt(k,1,`font-medium ${f??""}`),v(A,C),v(Y,`${t(m).progress.processed??""} / ${t(m).progress.total??""} `),v(ot,`${I??""}%`),nt(O,1,`h-2 rounded-full transition-all duration-300 ${t(m).status==="processing"?"bg-blue-500":t(m).status==="completed"?"bg-green-500":t(m).status==="failed"?"bg-red-500":t(m).status==="paused"?"bg-orange-500":"bg-yellow-500"}`),ie(O,`width: ${Be??""}%`),v(L,`Started: ${Re??""}`)},[()=>h.getStatusIcon(t(m).status),()=>h.getStatusColor(t(m).status),()=>t(m).status.toUpperCase(),()=>h.getProgressPercentage(t(m)),()=>h.getProgressPercentage(t(m)),()=>new Date(t(m).created_at).toLocaleString()]),w(e,s)};N(Jt,e=>{t(St)&&t(m)&&e(we)})}var zt=o(Jt,2);{var Se=e=>{var s=sr(),i=o(a(s),2),d=a(i),p=o(a(d));ht(p,5,()=>t(xt).slice(0,5),yt,(b,l)=>{var u=ar(),x=a(u),c=a(x),y=a(c),k=a(y,!0);r(y);var A=o(y,2),T=a(A,!0);r(A),r(c),r(x);var F=o(x),Y=a(F),H=a(Y,!0);r(Y),r(F);var K=o(F),j=a(K),V=a(j),W=a(V);r(V);var ot=o(V,2),X=a(ot);r(ot),r(j),r(K);var O=o(K),Z=a(O,!0);r(O);var lt=o(O),it=a(lt);{var Yt=B=>{var L=tr(),J=a(L),tt=o(J,2);r(L),M("click",J,()=>h.pauseUpload(t(l).id)),M("click",tt,()=>h.cancelUpload(t(l).id)),w(B,L)},gt=B=>{var L=je(),J=Oe(L);{var tt=Q=>{var et=er(),ft=a(et),_=o(ft,2);r(et),M("click",ft,()=>h.resumeUpload(t(l).id)),M("click",_,()=>h.cancelUpload(t(l).id)),w(Q,et)},jt=Q=>{var et=rr();w(Q,et)};N(J,Q=>{t(l).status==="paused"?Q(tt):Q(jt,!1)},!0)}w(B,L)};N(it,B=>{t(l).status==="processing"?B(Yt):B(gt,!1)})}r(lt),r(u),E((B,L,J,tt)=>{v(k,B),v(T,t(l).fileName),nt(Y,1,`px-2 py-1 text-xs rounded-full ${t(l).status==="completed"?"bg-green-100 text-green-800":t(l).status==="failed"?"bg-red-100 text-red-800":t(l).status==="processing"?"bg-blue-100 text-blue-800":"bg-yellow-100 text-yellow-800"}`),v(H,L),nt(W,1,`h-1.5 rounded-full ${t(l).status==="completed"?"bg-green-500":t(l).status==="failed"?"bg-red-500":t(l).status==="processing"?"bg-blue-500":"bg-yellow-500"}`),ie(W,`width: ${J??""}%`),v(X,`${t(l).progress.processed??""}/${t(l).progress.total??""}`),v(Z,tt)},[()=>h.getStatusIcon(t(l).status),()=>t(l).status.toUpperCase(),()=>h.getProgressPercentage(t(l)),()=>new Date(t(l).created_at).toLocaleString()]),w(b,u)}),r(p),r(d),r(i),r(s),w(e,s)};N(zt,e=>{t(xt).length>0&&e(Se)})}var Ct=o(zt,2),Pt=o(a(Ct),2);E(()=>{t(P),Ye(()=>{t(wt)})});var At=a(Pt);At.value=At.__value="";var $e=o(At);ht($e,1,()=>t(wt),yt,(e,s)=>{var i=or(),d=a(i,!0);r(i);var p={};E(()=>{v(d,t(s).name_en),p!==(p=t(s).id)&&(i.value=(i.__value=t(s).id)??"")}),w(e,i)}),r(Pt),r(Ct);var Ft=o(Ct,2),Dt=o(a(Ft),2),Nt=a(Dt),Qt=o(a(Nt),2);dt(Qt),r(Nt);var Et=o(Nt,2),Gt=o(a(Et),2);dt(Gt),r(Et);var Mt=o(Et,2),Ht=o(a(Mt),2);dt(Ht),r(Mt);var Bt=o(Mt,2),Kt=o(a(Bt),2);dt(Kt),r(Bt);var Rt=o(Bt,2),Xt=o(a(Rt),2);dt(Xt),r(Rt);var Zt=o(Rt,2),te=o(a(Zt),2);dt(te),r(Zt),r(Dt);var _t=o(Dt,2),Ue=a(_t,!0);r(_t),r(Ft);var Tt=o(Ft,2),It=a(Tt),ke=o(a(It),2);r(It);var qt=o(It,2),ee=o(a(qt),2);Ve(ee,e=>n(mt,e),()=>t(mt)),rt(2),r(qt);var re=o(qt,2);{var Ce=e=>{var s=ir(),i=o(a(s),2),d=a(i),p=o(a(d));ht(p,5,()=>t($),yt,(b,l)=>{var u=lr(),x=a(u),c=a(x,!0);r(x);var y=o(x),k=a(y,!0);r(y);var A=o(y),T=a(A,!0);r(A);var F=o(A),Y=a(F,!0);r(F);var H=o(F),K=a(H,!0);r(H);var j=o(H),V=a(j,!0);r(j);var W=o(j),ot=a(W,!0);r(W);var X=o(W),O=a(X);let Z;var lt=a(O,!0);r(O),r(X),r(u),E(it=>{v(c,t(l).rowNumber),v(k,t(l).bill_no),v(T,t(l).bill_date),v(Y,t(l).bill_amount),v(K,t(l).customer),v(V,t(l).add_amt),v(ot,t(l).redeem),Z=nt(O,1,"text-sm",null,Z,it),v(lt,t(l).status)},[()=>({"text-green-600":t(l).status.includes("âœ…"),"text-yellow-600":t(l).status.includes("â³"),"text-purple-600":t(l).status.includes("âœ¨"),"text-red-600":t(l).status.includes("âœ—"),"text-blue-600":t(l).status.includes("Checking")})]),w(b,u)}),r(p),r(d),r(i),r(s),w(e,s)};N(re,e=>{t($t)&&e(Ce)})}var ae=o(re,2),vt=a(ae),Pe=a(vt,!0);r(vt);var Ae=o(vt,2);r(ae),r(Tt);var se=o(Tt,2);{var Fe=e=>{var s=dr(),i=o(a(s),2),d=a(i),p=a(d),b=a(p,!0);r(p),rt(2),r(d);var l=o(d,2),u=a(l),x=a(u,!0);r(u),rt(2),r(l);var c=o(l,2),y=a(c),k=a(y,!0);r(y),rt(2),r(c);var A=o(c,2),T=a(A),F=a(T,!0);r(T),rt(2),r(A),r(i),r(s),E(()=>{v(b,t(st).total),v(x,t(st).successful),v(k,t(st).invalidCustomers),v(F,t(st).errors)}),w(e,s)};N(se,e=>{t(st).total>0&&e(Fe)})}var oe=o(se,2);{var De=e=>{var s=cr(),i=o(a(s),2),d=a(i),p=o(a(d));ht(p,5,()=>t(Ut),yt,(b,l,u,x)=>{var c=nr(),y=a(c),k=a(y,!0);r(y);var A=o(y),T=a(A,!0);r(A);var F=o(A),Y=a(F,!0);r(F),r(c),E(()=>{v(k,t(l).row),v(T,t(l).customer),v(Y,t(l).error)}),w(b,c)}),r(p),r(d),r(i),r(s),w(e,s)};N(oe,e=>{t(Ut).length>0&&e(De)})}var le=o(oe,2);{var Ne=e=>{var s=ur(),i=a(s,!0);r(s),E(()=>v(i,t(U))),w(e,s)};N(le,e=>{t(U)&&e(Ne)})}var Ee=o(le,2);{var Me=e=>{var s=mr(),i=a(s,!0);r(s),E(()=>v(i,t(G))),w(e,s)};N(Ee,e=>{t(G)&&e(Me)})}r(kt),E(()=>{_t.disabled=t(z)||!t(P),v(Ue,t(z)?"Adding...":"Add Transaction"),vt.disabled=t(z)||!t(at)||!t(P),v(Pe,t(z)?"Uploading...":"Upload Excel File")}),Le(Pt,()=>t(P),e=>n(P,e)),ct(Qt,()=>t(g).bill_no,e=>R(g,t(g).bill_no=e)),ct(Gt,()=>t(g).bill_date,e=>R(g,t(g).bill_date=e)),ct(Ht,()=>t(g).bill_amount,e=>R(g,t(g).bill_amount=e)),ct(Kt,()=>t(g).customer,e=>R(g,t(g).customer=e)),ct(Xt,()=>t(g).add_amt,e=>R(g,t(g).add_amt=e)),ct(te,()=>t(g).redeem,e=>R(g,t(g).redeem=e)),M("click",_t,me),M("click",ke,he),M("change",ee,ve),M("click",vt,be),M("click",Ae,ye),w(ne,kt),qe()}export{Fr as component};
