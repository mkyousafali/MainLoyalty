import"../chunks/DsnmJJEf.js";import"../chunks/69_IOA4Y.js";import{o as Ot}from"../chunks/Y1pQyyvi.js";import{l as Pt,q as V,r as Rt,m as w,J as zt,t as y,n as p,o as Yt,a as t,y as _,$ as Gt,s as i,v as r,z as a,H as ht,C as W,w as m,B as v,x as Kt,A as Qt,u as l}from"../chunks/Ck91ypkQ.js";import{i as X}from"../chunks/RujGBxXx.js";import{e as ft,i as pt}from"../chunks/D775oJua.js";import{s as E}from"../chunks/B38bOHRo.js";import{b as Vt}from"../chunks/xkiwYR4x.js";import{i as Wt}from"../chunks/6tn_K0LM.js";import{s as Z}from"../chunks/CIOq__Tp.js";import{g as Xt}from"../chunks/Bc_wzfnz.js";import{b as _t}from"../chunks/Bt-Xh7oU.js";var Zt=w('<div class="flex justify-center items-center h-64 svelte-aj2hht"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>'),te=w('<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center"><p class="text-red-600"> </p> <button class="mt-2 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Try Again</button></div>'),ee=w("<option> </option>"),ae=w('<tr class="border-b hover:bg-gray-50 transition-colors"><td class="p-4 font-medium svelte-aj2hht"> </td><td class="p-4 svelte-aj2hht"> </td><td> </td><td class="p-4 svelte-aj2hht"><span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-medium"> </span></td></tr>'),re=w('<tr><td colspan="4" class="p-12 text-center text-gray-500 svelte-aj2hht"><div class="flex flex-col items-center gap-3 svelte-aj2hht"><span class="text-6xl">📋</span> <p class="text-lg font-medium"> </p> <p class="text-sm"> </p></div></td></tr>'),se=w('<div class="bg-white rounded-xl shadow p-6 mb-6"><div><label for="branch-filter" class="text-sm font-semibold whitespace-nowrap"> </label> <select id="branch-filter"></select> <div> </div></div></div> <div class="bg-white rounded-xl shadow"><div class="overflow-x-auto"><table><thead><tr class="bg-gray-100 text-gray-600 font-semibold"><th class="p-4 svelte-aj2hht"> </th><th class="p-4 svelte-aj2hht"> </th><th class="p-4 svelte-aj2hht"> </th><th class="p-4 svelte-aj2hht"> </th></tr></thead><tbody><!></tbody></table></div></div>',1),oe=w('<div><main class="p-6 max-w-6xl mx-auto"><!></main></div>');function ge(gt,bt){Pt(bt,!1);const o=_(),I=_(),j=_();let s=_("en"),xt=null,S=_([]),M=_(!0),T=_(""),B=_("all"),U=_([]);Ot(()=>{const e=localStorage.getItem("selectedLanguage");e&&i(s,e),tt()});const yt={en:{transactionHistory:"Transaction History",filterByBranch:"Filter by Branch",allBranches:"All Branches",date:"Date",branch:"Branch",amount:"Amount",status:"Status",completed:"Completed",noTransactions:"No transactions found",startShopping:"Start shopping to see your purchase history!"},ar:{transactionHistory:"تاريخ المعاملات",filterByBranch:"فلترة حسب الفرع",allBranches:"جميع الفروع",date:"التاريخ",branch:"الفرع",amount:"المبلغ",status:"الحالة",completed:"مكتمل",noTransactions:"لا توجد معاملات",startShopping:"ابدأ التسوق لرؤية تاريخ مشترياتك!"}};async function tt(){try{i(M,!0),i(T,"");const e=JSON.parse(localStorage.getItem("loyaltyUser")||"{}");if(console.log("🔍 Transactions: Current user from localStorage:",e),!e.mobile){i(T,"No user found. Please login again."),console.log("❌ Transactions: No mobile found in localStorage"),_t&&Xt("/login");return}const{data:d,error:A}=await Z.from("customers").select("*").eq("customer_code",e.mobile).single();if(A||!d){console.error("❌ Transactions: Error fetching customer:",A),i(T,"Customer not found. Please contact support.");return}xt=d;const{data:C,error:N}=await Z.from("branches").select("*").order("name");N?(console.warn("⚠️ Transactions: Error fetching branches:",N),i(U,[])):i(U,C||[]),console.log("🔍 Transactions: Fetching all transactions for customer_code:",d.customer_code);const{data:g,error:f}=await Z.from("customer_transactions").select(`
          *,
          branches (
            name,
            name_ar
          )
        `).eq("customer_code",d.customer_code).order("bill_date",{ascending:!1}).order("created_at",{ascending:!1});f?(console.warn("⚠️ Transactions: Error fetching transactions:",f),i(S,[])):(i(S,g||[]),console.log("✅ Transactions: All transactions loaded:",t(S).length))}catch(e){console.error("💥 Transactions: Unexpected error:",e),i(T,`Unexpected error: ${e}`)}finally{i(M,!1)}}function wt(e){if(!e)return"N/A";try{const d=new Date(e),A=d.getDate().toString().padStart(2,"0"),C=(d.getMonth()+1).toString().padStart(2,"0"),N=d.getFullYear();return`${A}/${C}/${N}`}catch{return"N/A"}}function jt(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"SAR",minimumFractionDigits:2}).format(e).replace("SAR","﷼")}V(()=>t(s),()=>{i(o,yt[t(s)])}),V(()=>(t(s),t(U)),()=>{i(I,t(s)==="ar"?[{id:"all",name:"جميع الفروع"},...t(U).map(e=>({id:e.id,name:e.name_ar||e.name}))]:[{id:"all",name:"All Branches"},...t(U).map(e=>({id:e.id,name:e.name}))])}),V(()=>(t(B),t(S)),()=>{i(j,t(B)==="all"?t(S):t(S).filter(e=>e.branch_id===t(B)))}),Rt(),Wt();var $=oe();zt(e=>{Gt.title="Transaction History - Urban Market Loyalty"});let et;var at=r($),St=r(at);{var Tt=e=>{var d=Zt();p(e,d)},Bt=e=>{var d=ht(),A=W(d);{var C=g=>{var f=te(),x=r(f),F=r(x,!0);a(x);var k=m(x,2);a(f),y(()=>v(F,t(T))),Kt("click",k,tt),p(g,f)},N=g=>{var f=se(),x=W(f),F=r(x);let k;var J=r(F),At=r(J);a(J);var H=m(J,2);y(()=>{t(B),Qt(()=>{t(s),t(I)})});let rt;ft(H,5,()=>t(I),pt,(u,c)=>{var h=ee(),b=r(h,!0);a(h);var n={};y(()=>{v(b,(t(c),l(()=>t(c).name))),n!==(n=(t(c),l(()=>t(c).id)))&&(h.value=(h.__value=(t(c),l(()=>t(c).id)))??"")}),p(u,h)}),a(H);var O=m(H,2);let st;var Nt=r(O);a(O),a(F),a(x);var ot=m(x,2),nt=r(ot),P=r(nt);let lt;var R=r(P),ct=r(R),z=r(ct),Dt=r(z,!0);a(z);var Y=m(z),Et=r(Y,!0);a(Y);var G=m(Y),Ut=r(G,!0);a(G);var it=m(G),Ct=r(it,!0);a(it),a(ct),a(R);var dt=m(R),Ft=r(dt);{var Ht=u=>{var c=ht(),h=W(c);ft(h,1,()=>t(j),pt,(b,n)=>{var L=ae(),D=r(L),K=r(D,!0);a(D);var Q=m(D),$t=r(Q,!0);a(Q);var q=m(Q);let vt;var kt=r(q,!0);a(q);var mt=m(q),ut=r(mt),qt=r(ut,!0);a(ut),a(mt),a(L),y((It,Mt,Jt)=>{v(K,It),v($t,(t(s),t(n),l(()=>t(s)==="ar"?t(n).branches?.name_ar||t(n).branches?.name||"N/A":t(n).branches?.name||"N/A"))),vt=E(q,1,"p-4 font-semibold text-gray-900 svelte-aj2hht",null,vt,Mt),v(kt,Jt),v(qt,(t(o),l(()=>t(o).completed)))},[()=>(t(n),l(()=>wt(t(n).bill_date||t(n).created_at))),()=>({"text-right":t(s)==="en","text-left":t(s)==="ar"}),()=>(t(n),l(()=>jt(t(n).amount||0)))]),p(b,L)}),p(u,c)},Lt=u=>{var c=re(),h=r(c),b=r(h),n=m(r(b),2),L=r(n,!0);a(n);var D=m(n,2),K=r(D,!0);a(D),a(b),a(h),a(c),y(()=>{v(L,(t(o),l(()=>t(o).noTransactions))),v(K,(t(o),l(()=>t(o).startShopping)))}),p(u,c)};X(Ft,u=>{t(j),l(()=>t(j).length>0)?u(Ht):u(Lt,!1)})}a(dt),a(P),a(nt),a(ot),y((u,c,h,b)=>{k=E(F,1,"flex items-center gap-4 svelte-aj2hht",null,k,u),v(At,`${t(o),l(()=>t(o).filterByBranch)??""}:`),rt=E(H,1,"px-3 py-2 border rounded-lg bg-gray-50 min-w-48 svelte-aj2hht",null,rt,c),st=E(O,1,"text-sm text-gray-500 ml-auto",null,st,h),v(Nt,`${t(j),l(()=>t(j).length)??""} ${t(s)==="ar"?"معاملة":"transactions"}`),lt=E(P,1,"w-full text-sm svelte-aj2hht",null,lt,b),v(Dt,(t(o),l(()=>t(o).date))),v(Et,(t(o),l(()=>t(o).branch))),v(Ut,(t(o),l(()=>t(o).amount))),v(Ct,(t(o),l(()=>t(o).status)))},[()=>({"flex-row-reverse":t(s)==="ar"}),()=>({"text-right":t(s)==="ar"}),()=>({"mr-auto":t(s)==="ar","ml-0":t(s)==="ar"}),()=>({"text-left":t(s)==="en","text-right":t(s)==="ar"})]),Vt(H,()=>t(B),u=>i(B,u)),p(g,f)};X(A,g=>{t(T)?g(C):g(N,!1)},!0)}p(e,d)};X(St,e=>{t(M)?e(Tt):e(Bt,!1)})}a(at),a($),y(e=>et=E($,1,"min-h-screen bg-[#f6f8fb] font-sans text-gray-800 svelte-aj2hht",null,et,e),[()=>({rtl:t(s)==="ar"})]),p(gt,$),Yt()}export{ge as component};
