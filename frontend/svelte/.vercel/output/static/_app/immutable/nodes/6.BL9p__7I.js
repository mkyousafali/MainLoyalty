import"../chunks/DsnmJJEf.js";import"../chunks/69_IOA4Y.js";import{o as Qe}from"../chunks/Y1pQyyvi.js";import{l as Ue,q as Fe,r as ze,m as k,t as j,v as a,w as s,x as Ge,a as t,n as T,o as Ve,s as p,y as f,z as e,A as de,B as m,u as v,C as Me,E as Rt}from"../chunks/Ck91ypkQ.js";import{i as et}from"../chunks/RujGBxXx.js";import{e as F,i as z}from"../chunks/D775oJua.js";import{s as Je}from"../chunks/B38bOHRo.js";import{s as oe}from"../chunks/CNyBBxAM.js";import{b as ve}from"../chunks/xkiwYR4x.js";import{i as Ye}from"../chunks/6tn_K0LM.js";import{s as q}from"../chunks/CIOq__Tp.js";var He=k("<option> </option>"),Ke=k('<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div> <p class="text-gray-600 mt-2">Loading analytics...</p></div>'),We=k('<div class="flex items-center justify-between"><div class="flex items-center"><div class="w-4 h-4 rounded-full mr-3"></div> <span class="font-medium"> </span></div> <div class="text-right"><div class="font-bold"> </div> <div class="text-sm text-gray-500"> </div></div></div>'),Xe=k('<div class="border-l-4 border-blue-400 pl-4"><div class="font-medium"> </div> <div class="grid grid-cols-3 gap-4 text-sm text-gray-600"><div><span class="font-medium"> </span> <span>customers</span></div> <div><span class="font-medium"> </span> <span>transactions</span></div> <div><span class="font-medium"> </span> <span>revenue</span></div></div></div>'),Ze=k('<div class="bg-white rounded-lg shadow p-6"><h3 class="text-lg font-semibold mb-4">Branch Performance</h3> <div class="space-y-4"></div></div>'),ta=k('<div class="flex justify-between items-center text-sm"><div><div class="font-medium"> </div> <div class="text-gray-500"> </div></div> <div class="text-right"><div class="font-medium"> </div> <div class="text-gray-500"> </div></div></div>'),ea=k('<div class="flex justify-between items-center text-sm"><div><div class="font-medium"> </div> <div class="text-gray-500 font-mono"> </div></div> <div class="text-right"><div class="font-medium"> </div> <div class="text-gray-500"> </div></div></div>'),aa=k('<div class="flex flex-col items-center"><div class="bg-blue-500 rounded-t"></div> <div class="text-xs text-gray-500 mt-1 transform -rotate-45 origin-left"> </div></div>'),ra=k('<div class="bg-white rounded-lg shadow p-6 mb-8"><h3 class="text-lg font-semibold mb-4">Customer Growth</h3> <div class="h-64 flex items-end space-x-2"></div></div>'),sa=k('<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="text-3xl text-blue-600 mr-4">👥</div> <div><p class="text-sm font-medium text-gray-500">Total Customers</p> <p class="text-2xl font-bold text-gray-900"> </p></div></div></div> <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="text-3xl text-green-600 mr-4">💰</div> <div><p class="text-sm font-medium text-gray-500">Total Revenue</p> <p class="text-2xl font-bold text-gray-900"> </p></div></div></div> <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="text-3xl text-purple-600 mr-4">🛒</div> <div><p class="text-sm font-medium text-gray-500">Total Transactions</p> <p class="text-2xl font-bold text-gray-900"> </p></div></div></div> <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="text-3xl text-orange-600 mr-4">⭐</div> <div><p class="text-sm font-medium text-gray-500">Points Issued</p> <p class="text-2xl font-bold text-gray-900"> </p></div></div></div> <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="text-3xl text-red-600 mr-4">🎁</div> <div><p class="text-sm font-medium text-gray-500">Points Redeemed</p> <p class="text-2xl font-bold text-gray-900"> </p></div></div></div> <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="text-3xl text-teal-600 mr-4">🔥</div> <div><p class="text-sm font-medium text-gray-500">Active Customers</p> <p class="text-2xl font-bold text-gray-900"> </p></div></div></div> <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="text-3xl text-indigo-600 mr-4">📈</div> <div><p class="text-sm font-medium text-gray-500">New Customers</p> <p class="text-2xl font-bold text-gray-900"> </p></div></div></div> <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center"><div class="text-3xl text-pink-600 mr-4">💳</div> <div><p class="text-sm font-medium text-gray-500">Avg Order Value</p> <p class="text-2xl font-bold text-gray-900"> </p></div></div></div></div> <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8"><div class="bg-white rounded-lg shadow p-6"><h3 class="text-lg font-semibold mb-4">Card Type Distribution</h3> <div class="space-y-4"></div></div> <!> <div><h3 class="text-lg font-semibold mb-4">Recent Transactions</h3> <div class="space-y-3"></div></div> <div class="bg-white rounded-lg shadow p-6"><h3 class="text-lg font-semibold mb-4">Recent Registrations</h3> <div class="space-y-3"></div></div></div> <!>',1),ia=k('<div class="fixed bottom-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50"> </div>'),da=k('<div class="p-6"><div class="max-w-7xl mx-auto"><div class="mb-8"><div class="flex justify-between items-center"><div><h1 class="text-3xl font-bold text-gray-900 mb-2">Analytics & Reports</h1> <p class="text-gray-600">Comprehensive analytics and insights for your loyalty program.</p></div> <button class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">📊 Export Data</button></div></div> <div class="bg-white rounded-lg shadow p-6 mb-6"><div class="flex flex-wrap gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label> <select class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"><option>Last 7 Days</option><option>Last 30 Days</option><option>Last 90 Days</option><option>Last Year</option></select></div> <div><label class="block text-sm font-medium text-gray-700 mb-2">Branch</label> <select class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"><option>All Branches</option><!></select></div></div></div> <!> <!></div></div>');function fa(le,ne){Ue(ne,!1);let at=f(!1),V=f(""),P=f("30days"),n=f(""),rt=f([]),M=f(0),$=f(0),G=f(0),J=f(0),Y=f(0),H=f(0),K=f(0),W=f(0),st=f([]),X=f([]),N=f([]),it=f([]),dt=f([]),ce=[],me=[];Qe(()=>{ue(),St()});async function ue(){try{const{data:r,error:i}=await q.from("branches").select("*").order("name_en");if(i)throw i;p(rt,r||[])}catch(r){p(V,`Failed to load branches: ${r.message}`)}}async function St(){try{p(at,!0);const r=_e();await Promise.all([pe(r),xe(),ge(r),fe(r),be(),ye(r)])}catch(r){p(V,`Failed to load analytics: ${r.message}`)}finally{p(at,!1)}}function _e(){const r=new Date;let i;switch(t(P)){case"7days":i=new Date(r.getTime()-10080*60*1e3);break;case"30days":i=new Date(r.getTime()-720*60*60*1e3);break;case"90days":i=new Date(r.getTime()-2160*60*60*1e3);break;case"1year":i=new Date(r.getTime()-365*24*60*60*1e3);break;default:i=new Date(r.getTime()-720*60*60*1e3)}return i.toISOString().split("T")[0]}async function pe(r){try{let i=q.from("customers").select("*",{count:"exact",head:!0});t(n)&&(i=i.eq("branch_id",t(n)));const{count:o}=await i;p(M,o||0);let l=q.from("customers").select("*",{count:"exact",head:!0}).gte("created_at",r);t(n)&&(l=l.eq("branch_id",t(n)));const{count:_}=await l;p(K,_||0);let u=q.from("transactions").select("bill_amount, add_amt, redeem").gte("bill_date",r);t(n)&&(u=u.eq("branch_id",t(n)));const{data:g}=await u;g&&(p($,g.length),p(G,g.reduce((L,I)=>L+(I.bill_amount||0),0)),p(J,g.reduce((L,I)=>L+(I.add_amt||0),0)),p(Y,g.reduce((L,I)=>L+(I.redeem||0),0)),p(W,t($)>0?t(G)/t($):0));let S=q.from("transactions").select("customer",{count:"exact"}).gte("bill_date",r);t(n)&&(S=S.eq("branch_id",t(n)));const{data:Q}=await S;p(H,Q?new Set(Q.map(L=>L.customer)).size:0)}catch(i){console.error("Error loading overview stats:",i)}}async function xe(){try{let r=q.from("customers").select(`
          card_types(name_en, color),
          points
        `);t(n)&&(r=r.eq("branch_id",t(n)));const{data:i}=await r;if(i){const o=i.reduce((l,_)=>{const u=_.card_types?.name_en||"No Card",g=_.card_types?.color||"#gray";return l[u]||(l[u]={name:u,color:g,count:0,totalPoints:0}),l[u].count++,l[u].totalPoints+=_.points||0,l},{});p(st,Object.values(o))}}catch(r){console.error("Error loading card type stats:",r)}}async function ge(r){try{if(t(n)){p(X,[]);return}const{data:i}=await q.from("branches").select(`
          *,
          customers(count),
          transactions!inner(bill_amount, bill_date)
        `);i&&p(X,i.map(o=>{const l=o.transactions.filter(_=>_.bill_date>=r);return{name:o.name_en,customers:o.customers.length,transactions:l.length,revenue:l.reduce((_,u)=>_+(u.bill_amount||0),0)}}))}catch(i){console.error("Error loading branch stats:",i)}}async function fe(r){try{let i=q.from("customers").select("created_at").gte("created_at",r).order("created_at");t(n)&&(i=i.eq("branch_id",t(n)));const{data:o}=await i;if(o){const l=o.reduce((_,u)=>{const g=new Date(u.created_at).toISOString().split("T")[0];return _[g]=(_[g]||0)+1,_},{});p(N,Object.entries(l).map(([_,u])=>({date:_,count:u})))}}catch(i){console.error("Error loading customer growth:",i)}}async function be(){try{let r=q.from("transactions").select(`
          *,
          customers(name)
        `).order("created_at",{ascending:!1}).limit(5);t(n)&&(r=r.eq("branch_id",t(n)));const{data:i}=await r;p(it,i||[]);let o=q.from("customers").select("*").order("created_at",{ascending:!1}).limit(5);t(n)&&(o=o.eq("branch_id",t(n)));const{data:l}=await o;p(dt,l||[])}catch(r){console.error("Error loading recent activities:",r)}}async function ye(r){try{let i=q.from("transactions").select("bill_date, bill_amount, add_amt, redeem").gte("bill_date",r).order("bill_date");t(n)&&(i=i.eq("branch_id",t(n)));const{data:o}=await i;if(o){const l=o.reduce((u,g)=>{const S=g.bill_date;return u[S]||(u[S]={date:S,revenue:0,pointsIssued:0,pointsRedeemed:0}),u[S].revenue+=g.bill_amount||0,u[S].pointsIssued+=g.add_amt||0,u[S].pointsRedeemed+=g.redeem||0,u},{}),_=Object.values(l);ce=_,me=_}}catch(i){console.error("Error loading chart data:",i)}}function Z(r){return new Intl.NumberFormat("en-SA",{style:"currency",currency:"SAR"}).format(r).replace("SAR","﷼")}function B(r){return new Intl.NumberFormat().format(r)}function he(){const r={overview:{totalCustomers:t(M),totalTransactions:t($),totalRevenue:t(G),totalPointsIssued:t(J),totalPointsRedeemed:t(Y),activeCustomers:t(H),newCustomersThisPeriod:t(K),averageOrderValue:t(W)},cardTypeStats:t(st),branchStats:t(X),dateRange:t(P),branch:t(n),exportDate:new Date().toISOString()},i=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),o=URL.createObjectURL(i),l=document.createElement("a");l.href=o,l.download=`analytics-report-${new Date().toISOString().split("T")[0]}.json`,l.click(),URL.revokeObjectURL(o)}Fe(()=>(t(P),t(n)),()=>{(t(P)||t(n))&&St()}),ze(),Ye();var ot=da(),Tt=a(ot),vt=a(Tt),kt=a(vt),we=s(a(kt),2);e(kt),e(vt);var lt=s(vt,2),Ot=a(lt),nt=a(Ot),ct=s(a(nt),2);j(()=>{t(P),de(()=>{})});var mt=a(ct);mt.value=mt.__value="7days";var ut=s(mt);ut.value=ut.__value="30days";var _t=s(ut);_t.value=_t.__value="90days";var qt=s(_t);qt.value=qt.__value="1year",e(ct),e(nt);var Lt=s(nt,2),pt=s(a(Lt),2);j(()=>{t(n),de(()=>{t(rt)})});var xt=a(pt);xt.value=xt.__value="";var De=s(xt);F(De,1,()=>t(rt),z,(r,i)=>{var o=He(),l=a(o,!0);e(o);var _={};j(()=>{m(l,(t(i),v(()=>t(i).name_en))),_!==(_=(t(i),v(()=>t(i).id)))&&(o.value=(o.__value=(t(i),v(()=>t(i).id)))??"")}),T(r,o)}),e(pt),e(Lt),e(Ot),e(lt);var jt=s(lt,2);{var Ce=r=>{var i=Ke();T(r,i)},Re=r=>{var i=sa(),o=Me(i),l=a(o),_=a(l),u=s(a(_),2),g=s(a(u),2),S=a(g,!0);e(g),e(u),e(_),e(l);var Q=s(l,2),L=a(Q),I=s(a(L),2),At=s(a(I),2),ke=a(At,!0);e(At),e(I),e(L),e(Q);var gt=s(Q,2),Et=a(gt),It=s(a(Et),2),Pt=s(a(It),2),Oe=a(Pt,!0);e(Pt),e(It),e(Et),e(gt);var ft=s(gt,2),Bt=a(ft),$t=s(a(Bt),2),Nt=s(a($t),2),qe=a(Nt,!0);e(Nt),e($t),e(Bt),e(ft);var bt=s(ft,2),Qt=a(bt),Ut=s(a(Qt),2),Ft=s(a(Ut),2),Le=a(Ft,!0);e(Ft),e(Ut),e(Qt),e(bt);var yt=s(bt,2),zt=a(yt),Gt=s(a(zt),2),Vt=s(a(Gt),2),je=a(Vt,!0);e(Vt),e(Gt),e(zt),e(yt);var ht=s(yt,2),Mt=a(ht),Jt=s(a(Mt),2),Yt=s(a(Jt),2),Ae=a(Yt,!0);e(Yt),e(Jt),e(Mt),e(ht);var Ht=s(ht,2),Kt=a(Ht),Wt=s(a(Kt),2),Xt=s(a(Wt),2),Ee=a(Xt,!0);e(Xt),e(Wt),e(Kt),e(Ht),e(o);var wt=s(o,2),Dt=a(wt),Zt=s(a(Dt),2);F(Zt,5,()=>t(st),z,(D,d)=>{var x=We(),b=a(x),c=a(b),h=s(c,2),w=a(h,!0);e(h),e(b);var R=s(b,2),C=a(R),y=a(C,!0);e(C);var O=s(C,2),A=a(O);e(O),e(R),e(x),j(E=>{oe(c,`background-color: ${t(d),v(()=>t(d).color)??""}`),m(w,(t(d),v(()=>t(d).name))),m(y,(t(d),v(()=>t(d).count))),m(A,`${E??""} pts`)},[()=>(t(d),v(()=>B(t(d).totalPoints)))]),T(D,x)}),e(Zt),e(Dt);var te=s(Dt,2);{var Ie=D=>{var d=Ze(),x=s(a(d),2);F(x,5,()=>t(X),z,(b,c)=>{var h=Xe(),w=a(h),R=a(w,!0);e(w);var C=s(w,2),y=a(C),O=a(y),A=a(O,!0);e(O),Rt(2),e(y);var E=s(y,2),U=a(E),Ct=a(U,!0);e(U),Rt(2),e(E);var se=s(E,2),ie=a(se),$e=a(ie,!0);e(ie),Rt(2),e(se),e(C),e(h),j(Ne=>{m(R,(t(c),v(()=>t(c).name))),m(A,(t(c),v(()=>t(c).customers))),m(Ct,(t(c),v(()=>t(c).transactions))),m($e,Ne)},[()=>(t(c),v(()=>Z(t(c).revenue)))]),T(b,h)}),e(x),e(d),T(D,d)};et(te,D=>{t(n)||D(Ie)})}var tt=s(te,2),ee=s(a(tt),2);F(ee,5,()=>(t(it),v(()=>t(it).slice(0,5))),z,(D,d)=>{var x=ta(),b=a(x),c=a(b),h=a(c,!0);e(c);var w=s(c,2),R=a(w);e(w),e(b);var C=s(b,2),y=a(C),O=a(y,!0);e(y);var A=s(y,2),E=a(A,!0);e(A),e(C),e(x),j((U,Ct)=>{m(h,(t(d),v(()=>t(d).customers?.name||"Unknown"))),m(R,`Bill #${t(d),v(()=>t(d).bill_no)??""}`),m(O,U),m(E,Ct)},[()=>(t(d),v(()=>Z(t(d).bill_amount))),()=>(t(d),v(()=>new Date(t(d).created_at).toLocaleDateString()))]),T(D,x)}),e(ee),e(tt);var ae=s(tt,2),re=s(a(ae),2);F(re,5,()=>(t(dt),v(()=>t(dt).slice(0,5))),z,(D,d)=>{var x=ea(),b=a(x),c=a(b),h=a(c,!0);e(c);var w=s(c,2),R=a(w,!0);e(w),e(b);var C=s(b,2),y=a(C),O=a(y);e(y);var A=s(y,2),E=a(A,!0);e(A),e(C),e(x),j(U=>{m(h,(t(d),v(()=>t(d).name))),m(R,(t(d),v(()=>t(d).customer))),m(O,`${t(d),v(()=>t(d).points)??""} pts`),m(E,U)},[()=>(t(d),v(()=>new Date(t(d).created_at).toLocaleDateString()))]),T(D,x)}),e(re),e(ae),e(wt);var Pe=s(wt,2);{var Be=D=>{var d=ra(),x=s(a(d),2);F(x,5,()=>t(N),z,(b,c)=>{var h=aa(),w=a(h),R=s(w,2),C=a(R,!0);e(R),e(h),j((y,O)=>{oe(w,`height: ${y??""}px; width: 20px;`),m(C,O)},[()=>(t(c),t(N),v(()=>t(c).count/Math.max(...t(N).map(y=>y.count))*200)),()=>(t(c),v(()=>new Date(t(c).date).toLocaleDateString()))]),T(b,h)}),e(x),e(d),T(D,d)};et(Pe,D=>{t(N),v(()=>t(N).length>0)&&D(Be)})}j((D,d,x,b,c,h,w,R)=>{m(S,D),m(ke,d),m(Oe,x),m(qe,b),m(Le,c),m(je,h),m(Ae,w),m(Ee,R),Je(tt,1,`bg-white rounded-lg shadow p-6 ${t(n)?"lg:col-span-1":""}`)},[()=>(t(M),v(()=>B(t(M)))),()=>(t(G),v(()=>Z(t(G)))),()=>(t($),v(()=>B(t($)))),()=>(t(J),v(()=>B(t(J)))),()=>(t(Y),v(()=>B(t(Y)))),()=>(t(H),v(()=>B(t(H)))),()=>(t(K),v(()=>B(t(K)))),()=>(t(W),v(()=>Z(t(W))))]),T(r,i)};et(jt,r=>{t(at)?r(Ce):r(Re,!1)})}var Se=s(jt,2);{var Te=r=>{var i=ia(),o=a(i,!0);e(i),j(()=>m(o,t(V))),T(r,i)};et(Se,r=>{t(V)&&r(Te)})}e(Tt),e(ot),Ge("click",we,he),ve(ct,()=>t(P),r=>p(P,r)),ve(pt,()=>t(n),r=>p(n,r)),T(le,ot),Ve()}export{fa as component};
