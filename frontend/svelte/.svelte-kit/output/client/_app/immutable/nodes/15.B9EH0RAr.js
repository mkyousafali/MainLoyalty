import"../chunks/DsnmJJEf.js";import"../chunks/69_IOA4Y.js";import{o as je}from"../chunks/Y1pQyyvi.js";import{l as qe,q as xe,r as Fe,m as U,t as D,a as e,x as w,n as I,o as Ge,y as n,w as s,v as l,s as r,z as d,B as p,u as x}from"../chunks/Ck91ypkQ.js";import{i as de}from"../chunks/RujGBxXx.js";import{e as He,i as Je}from"../chunks/D775oJua.js";import{r as A,s as Ke}from"../chunks/DvH4tfbe.js";import{s as le}from"../chunks/B38bOHRo.js";import{s as ge}from"../chunks/CNyBBxAM.js";import{a as B}from"../chunks/C4HntxLm.js";import{i as Qe}from"../chunks/6tn_K0LM.js";import{s as T}from"../chunks/CIOq__Tp.js";var We=U("<p> </p>"),Xe=U('<tr class="bg-purple-50 hover:bg-purple-100 text-purple-900 border-b border-purple-200"><td class="px-3 py-2"><input type="checkbox"/></td><td class="px-3 py-2 font-mono"> </td><td class="px-3 py-2"> </td><td class="px-3 py-2"> </td></tr>'),Ye=U("<p> </p>"),Ze=U("<p> </p>"),et=U('<div class="p-6 max-w-6xl mx-auto bg-white shadow rounded-xl"><h1 class="text-2xl font-bold text-red-600 mb-6">⏳ Extend Validity</h1> <div class="mb-10 bg-blue-50 p-5 rounded-lg border border-blue-200"><h2 class="text-lg font-semibold text-blue-700 mb-3">📘 Extend Single Card</h2> <div class="grid grid-cols-1 md:grid-cols-3 gap-4"><input type="text" placeholder="Enter card number" class="border px-3 py-2 rounded"/> <input type="date" class="border px-3 py-2 rounded"/> <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Extend</button></div> <!></div> <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-semibold text-gray-800">📋 Registered Customers</h2> <input type="text" placeholder="🔍 Search by name or number" class="border px-3 py-2 rounded w-64"/></div> <div class="h-[320px] overflow-y-scroll border border-purple-300 rounded-md shadow-sm mb-6"><table class="w-full text-sm text-left border-collapse min-w-[600px]"><thead class="sticky top-0 bg-purple-100 text-purple-900"><tr><th class="px-3 py-2 border-b border-purple-300">✔️</th><th class="px-3 py-2 border-b border-purple-300 cursor-pointer"> </th><th class="px-3 py-2 border-b border-purple-300 cursor-pointer"> </th><th class="px-3 py-2 border-b border-purple-300 cursor-pointer"> </th></tr></thead><tbody></tbody></table></div> <div class="bg-yellow-50 p-5 border border-yellow-200 rounded-lg"><h3 class="font-semibold text-yellow-800 mb-2">⚡ Bulk Extend</h3> <div class="flex flex-wrap gap-4 items-center mb-2"><input type="date" class="border px-3 py-2 rounded"/> <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition disabled:bg-blue-300"> </button></div> <!> <div class="w-full bg-gray-200 rounded-full h-3"><div class="bg-green-500 h-3 rounded-full transition-all duration-300"></div></div> <p class="text-sm text-gray-600 mt-1"> </p></div> <div class="mt-8 bg-yellow-50 p-5 border border-yellow-200 rounded-lg"><h3 class="font-semibold text-yellow-800 mb-3">🟡 Extend All Registered Customers</h3> <div class="flex flex-wrap gap-4 items-center mb-3"><input type="date" class="border px-3 py-2 rounded"/> <button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition disabled:bg-red-300">Extend All</button></div> <!> <div class="w-full bg-gray-200 rounded-full h-3"><div class="bg-red-500 h-3 rounded-full transition-all duration-300"></div></div> <p class="text-sm text-gray-600 mt-1"> </p></div></div>');function vt(fe,ye){qe(ye,!1);let $=n(""),E=n(""),u=n(""),g=n(""),k=n([]),S=n([]),c=n([]),C=n(""),y=n(0),v=n(""),f=n("card_number"),b=n(!0),h=n(""),m=n(0),_=n("");je(async()=>{await M()});async function M(){try{const{data:t,error:a}=await T.from("customers").select(`
          id,
          card_number,
          full_name,
          valid_until,
          is_active,
          card_types (
            name,
            color
          )
        `).order("card_number");if(a)throw a;r(k,t.map(i=>({id:i.id.toString(),card_number:i.card_number,name:i.full_name||"Unknown",valid_until:i.valid_until?new Date(i.valid_until).toISOString().split("T")[0]:"Not set",is_active:i.is_active,card_type:i.card_types?.name||"Bronze"}))),r(S,[...e(k)])}catch(t){console.error("Error loading customers:",t),r(u,"❌ Error loading customer data")}}function he(t){r(c,e(c).includes(t)?e(c).filter(a=>a!==t):[...e(c),t])}async function we(){if(!e($)||!e(E)){r(u,"❌ Fill both fields");return}r(u,"Processing...");try{const{data:t,error:a}=await T.rpc("extend_card_validity",{card_num:e($),new_expiry_date:new Date(e(E)).toISOString()});if(a)throw a;t.success?(r(u,`✅ Extended card ${e($)} to ${e(E)}`),await M(),r($,""),r(E,"")):r(u,`❌ ${t.message}`)}catch(t){console.error("Error extending card validity:",t),r(u,"❌ Error extending card validity")}}async function $e(){if(!e(g)||e(c).length===0){r(v,"❌ Select customers and date");return}r(y,0),r(v,"Processing...");try{const t=e(k).filter(o=>e(c).includes(o.id)).map(o=>o.card_number),{data:a,error:i}=await T.rpc("extend_multiple_cards_validity",{card_numbers:t,new_expiry_date:new Date(e(g)).toISOString()});if(i)throw i;a.success?(r(v,`✅ Updated ${a.updated_count} customers to expire on ${e(g)}`),await M(),r(c,[]),r(g,""),r(y,100),setTimeout(()=>r(y,0),2e3)):r(v,`❌ ${a.message}`)}catch(t){console.error("Error extending bulk validity:",t),r(v,"❌ Error extending card validity")}}function V(t){e(f)===t?r(b,!e(b)):(r(f,t),r(b,!0))}async function Ee(){if(!e(h)){r(_,"❌ Select a valid date");return}r(_,"Updating all cards..."),r(m,50);try{const{data:t,error:a}=await T.rpc("extend_all_cards_validity",{new_expiry_date:new Date(e(h)).toISOString()});if(a)throw a;t.success?(r(m,100),r(_,`✅ Extended all ${t.updated_count} cards to ${e(h)}`),await M(),r(h,""),setTimeout(()=>r(m,0),3e3)):(r(_,`❌ ${t.message}`),r(m,0))}catch(t){console.error("Error extending all card validity:",t),r(_,"❌ Error extending all cards"),r(m,0)}}xe(()=>(e(C),e(k)),()=>{e(C)?r(S,e(k).filter(t=>t.card_number.includes(e(C))||t.name.toLowerCase().includes(e(C).toLowerCase()))):r(S,[...e(k)])}),xe(()=>(e(S),e(f),e(b)),()=>{e(S).sort((t,a)=>{const i=t[e(f)],o=a[e(f)];return i<o?e(b)?-1:1:i>o?e(b)?1:-1:0})}),Fe(),Qe();var z=et(),L=s(l(z),2),R=s(l(L),2),j=l(R);A(j);var q=s(j,2);A(q);var ke=s(q,2);d(R);var Se=s(R,2);{var Ce=t=>{var a=We(),i=l(a,!0);d(a),D(o=>{le(a,1,`mt-3 text-sm font-medium ${o??""}`),p(i,e(u))},[()=>(e(u),x(()=>e(u).includes("✅")?"text-green-600":"text-red-600"))]),I(t,a)};de(Se,t=>{e(u)&&t(Ce)})}d(L);var F=s(L,2),se=s(l(F),2);A(se),d(F);var G=s(F,2),ie=l(G),H=l(ie),oe=l(H),O=s(l(oe)),Ae=l(O);d(O);var N=s(O),De=l(N);d(N);var J=s(N),Ie=l(J);d(J),d(oe),d(H);var ne=s(H);He(ne,5,()=>e(S),Je,(t,a)=>{var i=Xe(),o=l(i),te=l(o);A(te),d(o);var re=s(o),Ve=l(re,!0);d(re);var ae=s(re),ze=l(ae,!0);d(ae);var _e=s(ae),Le=l(_e,!0);d(_e),d(i),D(Re=>{Ke(te,Re),p(Ve,(e(a),x(()=>e(a).card_number))),p(ze,(e(a),x(()=>e(a).name))),p(Le,(e(a),x(()=>e(a).valid_until)))},[()=>(e(c),e(a),x(()=>e(c).includes(e(a).id)))]),w("change",te,()=>he(e(a).id)),I(t,i)}),d(ne),d(ie),d(G);var K=s(G,2),Q=s(l(K),2),W=l(Q);A(W);var P=s(W,2),Be=l(P);d(P),d(Q);var ce=s(Q,2);{var Ue=t=>{var a=Ye(),i=l(a,!0);d(a),D(o=>{le(a,1,`text-sm font-medium ${o??""} mb-2`),p(i,e(v))},[()=>(e(v),x(()=>e(v).includes("✅")?"text-green-600":"text-red-600"))]),I(t,a)};de(ce,t=>{e(v)&&t(Ue)})}var X=s(ce,2),Me=l(X);d(X);var pe=s(X,2),Oe=l(pe);d(pe),d(K);var ue=s(K,2),Y=s(l(ue),2),Z=l(Y);A(Z);var ve=s(Z,2);d(Y);var be=s(Y,2);{var Ne=t=>{var a=Ze(),i=l(a,!0);d(a),D(o=>{le(a,1,`text-sm font-medium ${o??""} mb-2`),p(i,e(_))},[()=>(e(_),x(()=>e(_).includes("✅")?"text-green-600":"text-red-600"))]),I(t,a)};de(be,t=>{e(_)&&t(Ne)})}var ee=s(be,2),Pe=l(ee);d(ee);var me=s(ee,2),Te=l(me);d(me),d(ue),d(z),D(()=>{p(Ae,`Card Number ${e(f)==="card_number"?e(b)?"↑":"↓":""}`),p(De,`Name ${e(f)==="name"?e(b)?"↑":"↓":""}`),p(Ie,`Current Expiry ${e(f)==="valid_until"?e(b)?"↑":"↓":""}`),P.disabled=(e(g),e(c),x(()=>!e(g)||e(c).length===0)),p(Be,`Extend Selected (${e(c),x(()=>e(c).length)??""})`),ge(Me,`width: ${e(y)??""}%`),p(Oe,`${e(y)??""}% ${e(y)===0?"Idle":e(y)===100?"Complete":"Updating..."}`),ve.disabled=!e(h),ge(Pe,`width: ${e(m)??""}%`),p(Te,`${e(m)??""}% ${e(m)===0?"Idle":e(m)===100?"Complete":"Updating..."}`)}),B(j,()=>e($),t=>r($,t)),B(q,()=>e(E),t=>r(E,t)),w("click",ke,we),B(se,()=>e(C),t=>r(C,t)),w("click",O,()=>V("card_number")),w("click",N,()=>V("name")),w("click",J,()=>V("valid_until")),B(W,()=>e(g),t=>r(g,t)),w("click",P,$e),B(Z,()=>e(h),t=>r(h,t)),w("click",ve,Ee),I(fe,z),Ge()}export{vt as component};
